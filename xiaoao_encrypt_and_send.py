import socket
import struct

'''
笑傲梦幻破解
构造数据包并发送到远程服务器
'''

from xiaoao_decrypt import decrypt_data

flag = 381990860
key = "FT@!xasd"
keyArray = key.encode()


def make_data(num, msg):
    ret_buffer = bytearray()
    numbers = struct.pack('i', 1)
    number = struct.pack('i', num)
    msg_byte = msg.encode('GB18030')
    res_arr = numbers + number + msg_byte

    for i in range(len(res_arr)):
        decode_byte = res_arr[i] ^ keyArray[i % len(keyArray)]
        ret_buffer.append(decode_byte)

    data_length = len(res_arr)
    ret_buffer = struct.pack('i', flag) + struct.pack('i', 0) + struct.pack('i', data_length) + ret_buffer
    print("发送的消息",ret_buffer)
    return ret_buffer


def send_msg(msg):
    # Server information
    server_address = 'server.daddywolf.cn'
    server_port = 9097

    # Create a TCP socket
    client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

    try:
        # Connect to the server
        client_socket.connect((server_address, server_port))

        # Send data to the server
        client_socket.sendall(msg)

        # Receive data from the server
        response_data = client_socket.recv(1024)  # Adjust buffer size as needed

        decrypted_data = decrypt_data(response_data, keyArray, flag)
        decoded_str = decrypted_data[8:].decode('GB18030')
        print('返回的消息',decoded_str)

    finally:
        # Close the socket
        client_socket.close()


if __name__ == "__main__":
    data = make_data(1003, "do local ret={[1]=" + '40002' + ",[2]=\"" + 'VIP玩家' + "\"} return ret end")
    send_msg(data)
